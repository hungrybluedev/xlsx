name: Code Quality

on: [push, pull_request]

jobs:
  code-quality:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
    runs-on: ${{ matrix.os }}
    if: >
        github.event_name != 'push'
        || github.event.ref == 'refs/heads/master'
        || github.event.repository.full_name != 'hungrybluedev/xlsx'

    steps:
      - name: Checkout Latest V
        uses: actions/checkout@v4
        with:
          repository: vlang/v
          path: v

      - name: Checkout the XLSX module
        uses: actions/checkout@v4
        with:
          path: xlsx

      - name: Build V with make
        if: ${{ !startsWith(matrix.os, 'windows') }}
        run: |
          cd v
          make
          ./v symlink -githubci
      - name: Build V with make.bat
        if: ${{ startsWith(matrix.os, 'windows') }}
        run: |
          cd v
          .\make.bat
          .\v.exe symlink -githubci

      - name: Clone to ~/.vmodules/xlsx as well, as VPM does
        run: |
          git clone xlsx/ ${{ runner.temp }}/vmodules/xlsx
          echo "VMODULES=${{ runner.temp }}/vmodules" >> $GITHUB_ENV

      - name: Run tests
        run: cd xlsx && v test .

      - name: Ensure code is formatted
        run: cd xlsx && v fmt -verify .

      - name: Ensure documentation is OK
        run: cd xlsx && v check-md .
